<section>
  <h1>Welcome to the Zombo3 Zone</h1>
  <p>Post comments, read the feed, and later we'll analyze all the security problems.</p>
  <p><a class="btn" href="/comments">Go to Feed</a></p>
</section>

<hr>

<section style="margin-top: 24px;">
  <h2>Real-time Chat</h2>

  <div
    id="chatBox"
    style="border:1px solid #ccc; padding:12px; height:220px; overflow:auto; margin-bottom:8px;"
  >
    <div><em>Chat connected. Say something…</em></div>
  </div>

  <form id="chatForm">
    <input
      id="chatInput"
      name="text"
      type="text"
      placeholder="Type a message…"
      style="width:70%;"
      autocomplete="off"
    />
    <button type="submit">Send</button>
  </form>
</section>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    const sock = window.socket;
    if (!sock) {
      console.log('chat: no socket available');
      return;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function addMsg(user, text, nameColor, timestamp) {
      const div = document.createElement('div');

      const safeUser = escapeHtml(user);
      const safeText = escapeHtml(text);

      const ts = typeof timestamp === 'number' ? new Date(timestamp) : null;
      const timeStr = ts ? ts.toLocaleString() : '';

      if (nameColor) {
        div.innerHTML =
          `<span style="opacity:0.7; margin-right:6px;">[${escapeHtml(timeStr)}]</span>` +
          `<strong style="color:${nameColor}">${safeUser}</strong>: ${safeText}`;
      } else {
        div.textContent = `[${timeStr}] ${user}: ${text}`;
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Load chat history on connect
    sock.on('chat:history', (messages) => {
      chatBox.innerHTML = '';
      for (const msg of messages) {
        addMsg(
          msg.user,
          msg.message || msg.text,
          msg.name_color,
          msg.timestamp
        );
      }
    });

    // Live messages
    sock.on('chat:message', (msg) => {
      addMsg(
        msg.user,
        msg.message || msg.text,
        msg.name_color,
        msg.timestamp
      );
    });

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = chatInput.value;
      if (!text.trim()) return;
      sock.emit('chat:send', { text });
      chatInput.value = '';
    });
  });
</script>
